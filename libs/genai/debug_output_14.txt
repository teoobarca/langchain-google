/Users/hamper/Documents/Programming/nexana/langchain-google/.venv/lib/python3.14/site-packages/langsmith/schemas.py:22: UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
  from pydantic.v1 import (
============================= test session starts ==============================
platform darwin -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0
rootdir: /Users/hamper/Documents/Programming/nexana/langchain-google/libs/genai
configfile: pyproject.toml
plugins: anyio-4.11.0, langsmith-0.4.46
collected 1 item

tests/unit_tests/test_chat_models.py DEBUG: _convert_to_parts part='Test message'
DEBUG: _convert_to_parts part='First message'
DEBUG: _convert_to_parts part={'thought': True, 'text': 'I need to think...', 'thought_signature': 'dGVzdF9zaWdfZGF0YQ=='}
DEBUG: _convert_to_parts part={'text': 'Final answer', 'thought_signature': 'dGVzdF9zaWdfZGF0YQ=='}
DEBUG: _convert_to_parts part='Follow up'
F

=================================== FAILURES ===================================
_____________________ test_signature_round_trip_conversion _____________________

    def test_signature_round_trip_conversion() -> None:
        """Test complete round-trip signature handling in conversation context."""
    
        # Create a mock response with thought signature
        binary_sig = b"test_sig_data"
        mock_response = GenerateContentResponse(
            candidates=[
                Candidate(
                    content=Content(
                        parts=[
                            Part(
                                text="I need to think...",
                                thought=True,
                                thought_signature=binary_sig,
                            ),
                            Part(text="Final answer", thought_signature=binary_sig),
                        ]
                    )
                )
            ]
        )
    
        with patch("langchain_google_genai.chat_models._chat_with_retry") as mock_chat:
            mock_chat.return_value = mock_response
    
            llm = ChatGoogleGenerativeAI(
                model=MODEL_NAME,
                google_api_key=SecretStr(FAKE_API_KEY),
                output_version="v1",
                include_thoughts=True,
            )
    
            # First call - get response with signatures
            result = llm.invoke("Test message")
    
            # Verify signatures were extracted
            assert isinstance(result.content, list)
    
            # Find blocks with signatures
            sig_blocks = []
            for block in result.content:
                if isinstance(block, dict):
                    if block.get("type") == "reasoning" and "signature" in block:
                        sig_blocks.append(block)
                    elif block.get("extras") and "signature" in block["extras"]:
                        sig_blocks.append(block)
    
            assert len(sig_blocks) >= 1, (
                f"Expected signature blocks, got content: {result.content}"
            )
    
            # Now simulate passing this result back in a conversation
            with patch(
                "langchain_google_genai.chat_models._convert_from_v1_to_generativelanguage_v1beta"
            ) as mock_convert:
                from langchain_google_genai._compat import (
                    _convert_from_v1_to_generativelanguage_v1beta as real_convert,
                )
    
                mock_convert.side_effect = real_convert
    
                # Create conversation with the signature-containing message
                conversation = [
                    HumanMessage(content="First message"),
                    result,  # This contains signatures
                    HumanMessage(content="Follow up"),
                ]
    
                # This should trigger signature conversion
                mock_chat.return_value = GenerateContentResponse(
                    candidates=[
                        Candidate(content=Content(parts=[Part(text="Follow up response")]))
                    ]
                )
    
                follow_up = llm.invoke(conversation)
    
                # Verify that the request contained the signature
                assert mock_chat.call_count >= 2  # Initial call + follow up
                call_args = mock_chat.call_args
                assert "contents" in call_args.kwargs
                contents = call_args.kwargs["contents"]
    
                # Find the model message in history
                model_content = next(
                    (c for c in contents if c.role == "model"), None
                )
                assert model_content is not None
    
                # Verify it has thought signature
                has_signature = False
                for part in model_content.parts:
                    if part.thought_signature:
                        has_signature = True
                        # It should be bytes
                        assert isinstance(part.thought_signature, bytes)
                        break
    
>               assert has_signature, "Model message in history should have thought_signature"
E               AssertionError: Model message in history should have thought_signature
E               assert False

tests/unit_tests/test_chat_models.py:2585: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  langchain_google_genai.chat_models:chat_models.py:505 Unrecognized message part format. Assuming it's a text part.
WARNING  langchain_google_genai.chat_models:chat_models.py:505 Unrecognized message part format. Assuming it's a text part.
=============================== warnings summary ===============================
../../.venv/lib/python3.14/site-packages/_pytest/config/__init__.py:1397
  /Users/hamper/Documents/Programming/nexana/langchain-google/.venv/lib/python3.14/site-packages/_pytest/config/__init__.py:1397: PytestConfigWarning: Unknown config option: asyncio_mode
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

../../.venv/lib/python3.14/site-packages/google/genai/types.py:43
  /Users/hamper/Documents/Programming/nexana/langchain-google/.venv/lib/python3.14/site-packages/google/genai/types.py:43: DeprecationWarning: '_UnionGenericAlias' is deprecated and slated for removal in Python 3.17
    VersionedUnionType = Union[builtin_types.UnionType, _UnionGenericAlias]

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/unit_tests/test_chat_models.py::test_signature_round_trip_conversion
======================== 1 failed, 2 warnings in 1.45s =========================
